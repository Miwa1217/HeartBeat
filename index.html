<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-language" content="ja">
<meta charset="UTF-8">
<meta name="description" content="メトロノーム">
<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>HeartBeat</title>
<script>
var soundArray = [];
ind = "";

function init(){
    if(ind == "srt"){
        return;
    }
    ind = "srt";
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    context = new AudioContext();
    bufferLoader = new BufferLoader( context,'heart.mp3',finishedLoading );
    bufferLoader.load();
}

function BufferLoader(context, urlList, callback) {
    this.context = context;
    this.urlList = urlList;
    this.onload = callback;
    this.bufferList = new Array();
    this.loadCount = 0;
}

BufferLoader.prototype.loadBuffer = function(url, index) {
    // Load buffer asynchronously
    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";
    var loader = this;
    request.onload = function() {
        // Asynchronously decode the audio file data in request.response
        loader.context.decodeAudioData(
            request.response,
            function(buffer) {
                if (!buffer) {
                    alert('error decoding file data: ' + url);
                    return;
                }
                loader.bufferList[index] = buffer;
                if (++loader.loadCount == loader.urlList.length)
                    loader.onload(loader.bufferList);
            },
            function(error) {
                console.error('decodeAudioData error', error);
            }
        );
    }
    request.onerror = function() {
        alert('BufferLoader: XHR error');
    }
    request.send();
}

BufferLoader.prototype.load = function() {
    for (var i = 0; i < this.urlList.length; ++i)
    this.loadBuffer(this.urlList[i], i);
}

function finishedLoading(bufferList) {
    for (i = 0 ; i < bufferList.length ; i++ ) {
        var src = context.createBufferSource();
        src.buffer = bufferList[i];
        src.connect(context.destination);
        soundArray.push(src);
    }
    srt();
}

function srt(){
    bps = 60 / form.tmp.value;
    var startTime = context.currentTime;
    for(i = 0; i < 10 * 60 / bps; i++){
        soundArray[i].start(startTime + i * bps);
        soundArray[i] = context.createBufferSource();
        soundArray[i].buffer = bufferList[i];
        soundArray[i].connect(context.destination);
    }
}

function stp(){
    if(ind = "stp"){
        return;
    }
    ind = "stp";
    context.close();
}
       
</script>
</head>
<body>
<form name="form">
<table class="tbl" style="text-align:center;margin:0px auto;">
<tr><td style="background-color:#ffccf7">
<p>心拍数<input type="text" name="tmp" size="5" value="62">/分(BPM)</p>
<p><input type="button" value="start" onclick="init()">
<input type="button" value="stop" onclick="stp()"></p>
</td></tr></table>
</form>
</body>
</html>