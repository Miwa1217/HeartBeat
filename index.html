<!DOCTYPE html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>HeartBeat</title>
<style>
    #btn {
      font-size: 4rem;
      padding: 1rem 2rem;
    }
</style>

<script>
    window.AudioContext = window.AudioContext || window.webkitAudioContext;  
    var context = new AudioContext();
    // Audio 用の buffer を読み込む
    var getAudioBuffer = function(url, fn) {  
        var req = new XMLHttpRequest();
        // array buffer を指定
        req.responseType = 'arraybuffer';
        req.onreadystatechange = function() {
            if (req.readyState === 4) {
                if (req.status === 0 || req.status === 200) {
                    // array buffer を audio buffer に変換
                    context.decodeAudioData(req.response, function(buffer) {
                        // コールバックを実行
                        fn(buffer);
                    });
                }
            }
        };
        req.open('GET', url, true);
        req.send('');
    };

    // サウンドを再生
    var playSound = function(buffer) {  
        // source を作成
        var source1 = context.createBufferSource();
        var source2 = context.createBufferSource();
        // buffer をセット
        source1.buffer = snd[sn1];
        source2.buffer = snd[sn2];
        // context に connect
        source1.connect(context.destination);
        source2.connect(context.destination);

        bps = 60 / form.tmp.value;
        var startTime = context.currentTime;
        for ( i = 0 ; i < 10 * 60 / bps ; i++ ) {
            var source1 = context.createBufferSource();
            var source2 = context.createBufferSource();
            source1.buffer = snd[sn1] ;
            source2.buffer = snd[sn2] ;

            source1.connect(context.destination);
            source2.connect(context.destination);
            if ( i % 4 == 0 ) { 
                source1.start(startTime + i * bps ); 
            }
            else { 
                source2.start(startTime + i * bps ); 
            }
        }
        // 再生
        //source.start(0);
    };

    // main
    window.onload = function() {  
        // サウンドを読み込む
        getAudioBuffer('./Sound/heart.mp3', function(buffer) {
            // 読み込み完了後にボタンにクリックイベントを登録
            var btn = document.getElementById('btn');
            btn.onclick = function() {
                // サウンドを再生
                playSound(buffer);
            };
        });
    };


      bps = 60 / form.tmp.value ;
      
      var startTime = context.currentTime ;
      for ( i = 0 ; i < 10 * 60 / bps ; i++ ) {
        var source1 = context.createBufferSource();
        var source2 = context.createBufferSource();
        source1.buffer = snd[sn1] ;
        source2.buffer = snd[sn2] ;
    
        source1.connect(context.destination);
        source2.connect(context.destination);
        if ( i % hy== 0 ) { source1.start(startTime + i * bps ); }
          else { source2.start(startTime + i * bps ); }
      }
    }
    function BufferLoader(context, urlList, callback) {
      this.context = context;
      this.urlList = urlList;
      this.onload = callback;
      this.bufferList = new Array();
      this.loadCount = 0;
    }

    BufferLoader.prototype.load = function() {
      for (var i = 0; i < this.urlList.length; ++i)
      this.loadBuffer(this.urlList[i], i);
    }
</script>
<body>
    <p>脈拍：<input name="tmp" value="120" size="3">／分</p> 
    <button id='btn'>Play</button>
</body>
</html>